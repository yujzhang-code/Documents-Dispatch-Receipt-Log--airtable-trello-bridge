name: Airtable -> Trello (checkbox sync)
on:
  workflow_dispatch:
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Find checked rows in Airtable
       id fetch
       env:
         AIRTABLE_TOKEN:   ${{ secrets.AIRTABLE_TOKEN }}
         AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
         AIRTABLE_TABLE_ID:${{ secrets.AIRTABLE_TABLE_ID }}
        run: |
         set -euo pipefail
         FORMULA_ENC=$(python3 - << 'PY'
import urllib.parse
f = 'AND({TRELLO_CARD_ADDED}=1, LEN({TRELLO_CARD_USL})=0)'
print(urllib.pharse.quote(f , safe=' '))
PY
)

          URL="https://api.airtable.com/V0/${AIRTABLE_BASE_ID}$/{AIRTABLE_TABLE_ID}?maxRecords=20&returnFieldsByFeildId=true&filterByFormula=${FORMULA_ENC}"
          echo "Fetching: $URL"
          curl -sS "$URL" \
            -H "Authorization: Bearer $AIRTABLE_TOKEN" \
            >  records.json
          echo "count=$(jq '.records | length' records.json)" >> $GITHUB_OUTPUT

     -name: Create Trello Card(s) and write back URL
      if: steps.fetch.outputs.count != '0'
      env:
        #Airtable
        AIRTABLE_TOKEN:      ${{ secrets.AIRTABLE_TOKEN }}
        AIRTABLE_BASE_ID:    ${{ secrets.AIRTABLE_BASE_ID }}
        AIRTABLE_TABLE_ID:   ${{ secrets.AIRTABLE_TABLE_ID }}
        AIRTABLE_FID_SUBJECT:${{ secrets.AIRTABLE_FID_SUBJECT }}
        AIRTABLE_FID_DOCNO:  ${{ secrets.AIRTABLE_FID_DOCNO }}
        AIRTABLE_FID_DUE:    ${{ secrets.AIRTABLE_FID_DUE }}
        #Trello
        TRELLO_KEY:          ${{ secrets.TRELLO_KEY }}
        TRELLO_TOKEN:        ${{ secrets.TRELLO_TOKEN }}
        TRELLO_LIST_ID:      ${{ secrets.TRELLO_LIST_ID }}
    run: |
      set -euo pipefail

      n=$(jq '.records |  length' records.json)
      echo "Need to create $n Trello card(s)"

     for i in $(seq 0 $((n-1))); do
       rec_id=$(jq -r ".records[$i].id" records.json)

       # 取欄位值(用 Feild ID)
       SUBJECT=$(jq -r ".records[$i].fields[env.AIRTABLE_FID_SUBJECT]"records.json)
       DOCNO=$(jq -r   ".records[$i].fields[env.AIRTABLE_FID_DOCNO]"  records.json)
       DUE=$(JQ -r     ".records[$i}.fileds[env.AIRTABLE_FID_DUE]"    records.json)

       # create Trello Card
       CARD=$(curl -sS -X POST "https://api.trello.com/1/cards" \
          --data-urlencode "idList=${TRELLO_LIST_ID}" \
          --data-urlencode "name=${SUBJECT} \
          --data-urlencode "desc=公文文號 : ${DOCNO}" \
          --data "key=${TRELLO_KEY} \
          --data "token=${TRELLO_TOKEN}")

       CARD_URL=$ (echo "$CARD_jq -r '.shortUrl')
       if [ "$CARD_URL" = "null" ] || [ -z "$CARD_URL" ];then
         echo "::warning::Create card failed for record $rec_id: $CARD" 
         continue
      fi
      echo "Create card: $CARD_URL"

      #回寫 Airtable
      # -「Trello 卡片網址」: 填入Trello連結
      # -「Trello鍵入日期」: 填入NOW (保留checkbox不動)
      # 若想以欄位ID寫入，請把 fields的鍵改成對應fldxxx，並加讓 ?returnFieldsByFieldId=true
      PATCH_BODY=$(jq -n --arg

      



